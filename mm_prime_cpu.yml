---
-   hosts: localhost
    gather_facts: yes

    tasks:

    - name: GET the cpu values from CPI
      uri:
        url: 'https://10.23.77.200/webacs/api/v4/op/statisticsService/device/topNCPU.json?range=1&topN=10'
        validate_certs: no
        method: GET
        return_content: yes
        body_format: json
        headers:
            Content-Type: "application/json"
        user: devnet
        password: Maticmind2018
        force_basic_auth: yes
      register: prime_topn_cpu

    - debug:
        var: prime_topn_cpu.content
      

    - name: parse the JSON output from CPI and save it in a new dictionary
      set_fact: 
         prime_topn_cpu_json: "{{prime_topn_cpu.content | from_json }}"

    - debug:
        msg: "{{prime_topn_cpu_json}}"
        
    - name: get device cpu
      set_fact:
         deviceName: "{{item.statisticEntries.statisticEntry.5.entryValue}}"
         deviceIP: "{{item.statisticEntries.statisticEntry.6.entryValue}}"
         averageCPU: "{{item.statisticEntries.statisticEntry.4.entryValue}}"
         maxCPU: "{{item.statisticEntries.statisticEntry.3.entryValue}}"
         minCPU: "{{item.statisticEntries.statisticEntry.2.entryValue}}"
         currentCPU: "{{item.statisticEntries.statisticEntry.1.entryValue}}"
      with_items: "{{prime_topn_cpu_json.mgmtResponse.statisticsDTO}}"
      register: prime_loop_result
      
    - debug:
         msg: "{{prime_loop_result}}"
         
    - name: create clean list for elastic
      set_fact:
         device: "{{prime_loop_result.results | map(attribute='ansible_facts')|list}}"
    - debug:
         var: device
         
    - name: save output to elastic
      uri:
        url: 'http://10.23.77.202:9200/devicecpu-{{ansible_date_time.date}}/switch/{{ansible_date_time.epoch|hash('sha1')}}'
        method: PUT
        return_content: yes
        body_format: json
        body: '{"deviceName":"{{item.deviceName}}","deviceIP":"{{item.deviceIP}}","averageCPU":"{{item.averageCPU}}","maxCPU":"{{item.maxCPU}}","minCPU":"{{item.minCPU}}","currentCPU":"{{item.currentCPU}}"}'
        headers:
            Content-Type: "application/json"
        status_code: 201
      register: elastic_result
      with_items: "{{device}}"
      
      
     
    - debug:
            var: elastic_result.content
