---
-   hosts: localhost
    gather_facts: no

    vars:
       input_ipaddress: "10.22.22.69" 
    
    tasks:

    - name: get_device_ID_from_PRIME_in_JSON
      uri:
        url: https://10.23.77.200/webacs/api/v4/data/Devices.json?ipAddress={{input_ipaddress}}
        validate_certs: no
        method: GET
        return_content: yes
        headers:
            Content-Type: "application/json"
        user: devnet
        password: Maticmind2018
        force_basic_auth: yes
      register: device_ID

    - name: parse_deviceID
      set_fact: 
         deviceID_prime: "{{device_ID.content | from_json }}"
         
    - name: Clean Device URLs
      set_fact:
        Clean_Device_ID: "{{deviceID_prime['queryResponse']['entityId'][0]['$']}}"

#    - debug:
#            var: Clean_Device_ID

    - name: get_all_facts_from_selected_Device_from_PRIME
      uri:
        url: https://10.23.77.200/webacs/api/v4/data/InventoryDetails/{{Clean_Device_ID}}.json
        validate_certs: no
        method: GET
        return_content: yes
        headers:
            Content-Type: "application/json"
        user: devnet
        password: Maticmind2018
        force_basic_auth: yes
      register: device_facts

#    - name: Show ALL device facts
#      debug:
#            var: device_facts.content

    - name: parse the JSON output from CPI and save it in a new dictionary
      set_fact: 
         device_facts_json: "{{device_facts.content | from_json }}"

#    - name: Show ALL device facts
#      debug:
#            var: device_facts_json

    - name: get_switch_IPaddress
      set_fact: 
         switch_IP: "{{device_facts_json.queryResponse.entity[0].inventoryDetailsDTO.summary.ipAddress}}"

    - debug:
        var: switch_IP

    - name: Get specific Values from JSON
      set_fact:
         CDP_Neighbours: "{{CDP_Neighbours| default([]) + [item] }}"
      with_items: "{{
                    device_facts_json['queryResponse']['entity'][0]['inventoryDetailsDTO']['cdpNeighbors'] | list
                    }}"

    - debug:
           var: CDP_Neighbours

#    - name: get_CDP_interface
#      set_fact: 
#         CDP_int: "{{CDP_Neighbours[0].nearEndInterface}}"
#
#    - debug:
#           var: CDP_int
#
#    - name: get_CDP_Nei
#      set_fact: 
#         CDP_Nei: "{{CDP_Neighbours[0].neighborDeviceName}}"
#         
#    - debug:
#           var: CDP_Nei
#
#      
#
#-   hosts: MM_Vimodrone
#    gather_facts: no
#    connection: network_cli
#
#    vars:
#      ansible_network_os: ios
#
#    tasks:
#
#    - debug:
#       var: hostvars['localhost']['CDP_int']
#
#    - debug:
#       var: hostvars['localhost']['switch_IP']
#
#    - ios_command:
#        commands:
#          - configure terminal
#          - interface {{hostvars['localhost']['CDP_int']}}
#          - description Verso_{{hostvars['localhost']['CDP_Nei']}}
#          - end
#      with_items: "{{CDP_Neighbours}}"
#      when: ansible_host== hostvars['localhost']['switch_IP']


